datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

model User {
  id                Int       @id @default(autoincrement())
  utorid            String    @unique
  name              String
  email             String    @unique
  birthday          DateTime?
  role              RoleType  @default(regular)
  verified          Boolean   @default(false)
  suspicious        Boolean   @default(false)
  points            Int       @default(0)
  createdAt         DateTime  @default(now())
  lastLogin         DateTime?
  activated         Boolean   @default(false)
  avatarUrl         String?
  passwordHash      String?
  activationToken   String?   @unique
  activationExpires DateTime?
  resetToken        String?   @unique
  resetExpires      DateTime?
  
  // Relations
  createdTransactions    Transaction[] @relation("CreatedBy")
  targetTransactions     Transaction[] @relation("TargetUser")
  cashierTransactions    Transaction[] @relation("Cashier")
  managedEvents         Event[]       @relation("EventManager")
  organizedEvents       EventOrganizer[]
  guestEvents          EventGuest[]
  userPromotions       UserPromotion[]
  
  @@index([utorid])
  @@index([email])
  @@index([role])
  @@index([verified])
  @@index([activated])
}

model Transaction {
  id                   Int             @id @default(autoincrement())
  type                 TransactionType
  amountCents          Int?
  pointsDelta          Int
  createdAt            DateTime        @default(now())
  createdById          Int
  targetUserId         Int
  cashierId            Int?
  requiresVerification Boolean         @default(false)
  processed            Boolean           @default(false)
  processedAt          DateTime?
  
  // Relations
  createdBy  User  @relation("CreatedBy", fields: [createdById], references: [id])
  targetUser User  @relation("TargetUser", fields: [targetUserId], references: [id])
  cashier    User? @relation("Cashier", fields: [cashierId], references: [id])
  
  @@index([type])
  @@index([createdById])
  @@index([targetUserId])
  @@index([cashierId])
  @@index([processed])
  @@index([createdAt])
}

model Event {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?
  location      String?
  startAt       DateTime
  endAt         DateTime
  capacity      Int
  pointsBudget  Int
  managerId     Int
  
  // Relations
  manager         User             @relation("EventManager", fields: [managerId], references: [id])
  organizers      EventOrganizer[]
  guests          EventGuest[]
  
  @@index([managerId])
  @@index([startAt])
  @@index([endAt])
}

model EventOrganizer {
  id      Int @id @default(autoincrement())
  userId  Int
  eventId Int
  
  // Relations
  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

model EventGuest {
  id             Int     @id @default(autoincrement())
  userId         Int
  eventId        Int
  rsvp           Boolean @default(false)
  attended       Boolean @default(false)
  awardedPoints  Int     @default(0)
  
  // Relations
  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([rsvp])
  @@index([attended])
}

model Promotion {
  id                Int      @id @default(autoincrement())
  name              String
  startAt           DateTime
  endAt             DateTime
  minSpendingCents  Int?
  rateMultiplier    Float?
  oneTimePoints      Int?
  
  // Relations
  userPromotions UserPromotion[]
  
  @@index([startAt])
  @@index([endAt])
}

model UserPromotion {
  id          Int       @id @default(autoincrement())
  userId      Int
  promotionId Int
  usedAt      DateTime?
  
  // Relations
  user      User      @relation(fields: [userId], references: [id])
  promotion Promotion @relation(fields: [promotionId], references: [id])
  
  @@unique([userId, promotionId])
  @@index([userId])
  @@index([promotionId])
  @@index([usedAt])
}
